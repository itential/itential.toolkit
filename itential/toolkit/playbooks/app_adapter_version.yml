# Copyright (c) 2023, Itential, LLC
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# Example usage:
# ansible-playbook -i hosts app_adapter_version.yml 

- name: Adapter/App Version
  hosts: platform
  gather_facts: false
  connection: local
  vars_prompt:
    - name: adapterAppNamesCSV
      prompt: "Provide names of Adapter/App, separated by comma. Press ENTER without providing any names in order to get the versions of all adapters and applications"
      private: false

    - name: username
      prompt: "IAP username"
      private: false

    - name: password
      prompt: "IAP Password"
  
  tasks:
    - name: Convert adapterAppNamesCSV to list
      set_fact: 
        adapterAppNames: "{{ adapterAppNamesCSV.split(',') }}"

    - name: Login to IAP and get token
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:{{ http_port }}/login"
        method: POST
        body: '{"username": "{{ username }}", "password": "{{ password }}"}'
        body_format: json
        headers:
          Content-Type: "application/json"
        status_code: 200
        return_content: yes
      register: token

    - name: Extract token from login response
      set_fact:
        authToken: "?token={{ token.content }}"
    
    - name: Get the list of Adapters
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:{{ http_port }}/health/adapters{{ authToken }}"
        method: GET
        status_code: 200
        return_content: yes
      register: adaptersResponse
    
    - name: Extract the adapters response
      set_fact:
        adaptersResponse: "{{ adaptersResponse.content }}"
    
    - name: Extract the adapter information
      set_fact:
        adapters: "{{ adaptersResponse.results |  selectattr(\"id\", \"in\", adapterAppNames) | default([]) }}"
      when: adapterAppNames[0] != ""
    
    - name: Extract the adapter informations
      set_fact:
        adapters: "{{ adaptersResponse.results }}"
      when: adapterAppNames[0] == ""
    
    - name: Get the list of Applications
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:{{ http_port }}/health/applications{{ authToken }}"
        method: GET
        status_code: 200
        return_content: yes
      register: applicationsResponse

    - name: Extract the application response
      set_fact:
        applicationsResponse: "{{ applicationsResponse.content }}"
    
    - name: Get the application information
      set_fact:
        applications: "{{ applicationsResponse.results |  selectattr(\"id\", \"in\", adapterAppNames) | default([]) }}"
      when: adapterAppNames[0] != ""

    - name: Extract the adapter informations
      set_fact:
        applications: "{{ applicationsResponse.results }}"
      when: adapterAppNames[0] == ""

    - name: Grab adapter version
      set_fact: 
        adapterVersions: |
                          The adapters with their versions are:
                          ==========================================
                          {% for item in adapters %}
                          {{ item.id }}: {{ item.version }}
                          {% endfor %}

    - name: Grab application version
      set_fact: 
        applicationVersions: |
                              The applications with their versions are:
                              ==============================================
                              {% for item in applications %}
                              {{ item.id }}: {{ item.version }}
                              {% endfor %}

    - name: Grab the list of applications/adapters that are not found.
      set_fact:
        notFound: |
                  Following Adapters/Applications were not found:
                  ====================================================
                  {% set adaptersList = adaptersResponse.results | map(attribute='id') %}
                  {% set applicationsList = applicationsResponse.results | map(attribute='id') %}
                  {% for item in adapterAppNames %}
                  {% if item not in adaptersList and item not in applicationsList %}
                  {{ item }}
                  {% endif %}
                  {% endfor %}

    - name: Display the version of provided applications and adapters
      ansible.builtin.debug:
        msg:
          - "{{ adapterVersions.split('\n') }}"
          - "{{ applicationVersions.split('\n') }}"
          - "{{ notFound.split('\n') }}"
      when: adapterAppNames[0] != ""
    
    - name: Display the version of all applications and adapters
      ansible.builtin.debug:
        msg:
          - "{{ adapterVersions.split('\n') }}"
          - "{{ applicationVersions.split('\n') }}"
      when: adapterAppNames[0] == ""
