# Copyright (c) 2022, Itential, LLC
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---

- hosts: platform
  tasks:

    # Request an IAP session token to use with the following IAG requests.
    # Register the response from this login service to be referenced by later
    # tasks.
    - name: Get IAP token
      ansible.builtin.uri:
        url: "{{ iap_protocol }}://{{ inventory_hostname }}:{{ iap_port }}/login"
        method: POST
        body_format: json
        follow_redirects: true
        body:
          user:
            username: "{{ iap_username }}"
            password: "{{ iap_password }}"
      register: token_response

    # Using the requested token from the task above, invoke the API that will
    # restart each of the adapters defined in the "adapters" variable. The
    # "adapters" variable is a comma separated list of adapter names. This task
    # will loop through each of those names and restart them using the API.
    - name: Restart adapters
      ansible.builtin.uri:
        url: "{{ iap_protocol }}://{{ inventory_hostname }}:{{ iap_port }}/adapters/{{ item.strip() }}/restart?token={{ token_response.cookies.token }}"
        method: PUT
        body_format: json
        body: "{}"
        headers:
          accept: application/json
        follow_redirects: true
      with_items: "{{ adapters.split(',') }}"