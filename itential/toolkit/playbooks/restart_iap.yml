# Copyright (c) 2023, Itential, LLC
# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
---
# Example usage:
# ansible-playbook restart_iap.yml -i hosts
- name: Restart IAP
  hosts: platform
  gather_facts: false
  become: true
  tasks:
    - name: Get Auth token
      itential.platform.auth_token:
      delegate_to: localhost
      register: auth_token_response
      when: iap_auth_token is not defined

    - name: Store the auth token
      ansible.builtin.set_fact:
        iap_auth_token: "{{ auth_token_response.auth_token }}"
      when: iap_auth_token is not defined

    - name: Deactivate job workers
      itential.platform.deactivate_job_worker:
      delegate_to: localhost

    - name: Deactivate task workers
      itential.platform.deactivate_task_worker:
      delegate_to: localhost

    - name: Check active tasks until none are running
      itential.platform.get_tasks:
        status: running
      delegate_to: localhost
      register: active_tasks
      until: active_tasks.json.data | length == 0
      retries: 30
      delay: 10

    - name: Restart IAP
      ansible.builtin.systemd:
        name: automation-platform
        state: restarted
